---
- set_fact: mysql_restore_s3_bucket_path={{ mysql_restore_s3_bucket_parent.rstrip('/') }}
  when: mysql_restore_s3_bucket_parent != False

- set_fact: mysql_restore_s3_bucket_path={{ mysql_restore_s3_bucket.rstrip('/') }}
  when: mysql_restore_s3_bucket != False

- name: Determine latest MySQL backup in directory.
  shell: aws s3 ls s3://{{ mysql_restore_s3_bucket_path }}/ --profile {{ mysql_restore_aws_profile }} | sort | tail -n 1 | awk '{print $2}'
  register: mysql_restore_s3_backup_latest_result
  changed_when: False
  failed_when: mysql_restore_s3_backup_latest_result.stderr != ""
  when: mysql_restore_s3_bucket_parent != False

- set_fact: mysql_restore_s3_bucket_url={{ mysql_restore_s3_bucket_path }}/{{ mysql_restore_s3_backup_latest_result.stdout.rstrip('/') }}
  when: mysql_restore_s3_bucket_parent != False

- set_fact: mysql_restore_s3_bucket_url={{ mysql_restore_s3_bucket_path }}
  when: mysql_restore_s3_bucket != False

- block:

  - shell: echo --exclude "{{ item }}{{ mysql_restore_s3_backup_extension }}"
    with_items: "{{ mysql_restore_imported }}"
    register: mysql_restore_s3_backup_exclude_result
    changed_when: False

  - name: Download all S3 database backups.
    command: aws s3 sync s3://{{ mysql_restore_s3_bucket_url }}/ {{ mysql_restore_dir_realpath }}/ {{ mysql_restore_s3_backup_exclude_result.results | map(attribute='stdout') | join(' ') }} --profile {{ mysql_restore_aws_profile }}
    register: mysql_restore_s3_backup_download_result
    changed_when: mysql_restore_s3_backup_download_result.stdout != ""

  when: mysql_restore_databases | length == 0

- name: Download individual S3 database backups.
  command: aws s3 cp s3://{{ mysql_restore_s3_bucket_url }}/{{ item }}{{ mysql_restore_s3_backup_extension }} {{ mysql_restore_dir_realpath }}/ --profile {{ mysql_restore_aws_profile }}
  args:
    creates: "{{ mysql_restore_dir_realpath }}/{{ item }}{{ mysql_restore_s3_backup_extension }}"
  register: mysql_restore_s3_backup_download_result
  with_items: "{{ mysql_restore_databases }}"
  when: mysql_restore_databases | length > 0
